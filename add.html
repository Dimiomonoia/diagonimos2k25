<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClimateActionNow — Υποβολή Δράσης</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <meta name="description" content="Υποβολή δράσης — ClimateActionNow">
</head>
<body id="add">
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <span class="logo-box">
          <svg class="logo-globe" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M3 12h18"></path>
            <path d="M12 3a14 14 0 0 1 0 18"></path>
            <path d="M12 3a14 14 0 0 0 0 18"></path>
            <path d="M5.5 7.5c2 .8 4.7 1.2 6.5 1.2 1.8 0 4.5-.4 6.5-1.2"></path>
            <path d="M5.5 16.5c2-.8 4.7-1.2 6.5-1.2 1.8 0 4.5.4 6.5 1.2"></path>
          </svg>
        </span>
        <span class="brand-name">ClimateActionNow</span>
      </a>

      <nav style="margin-left:auto">
        <ul>
          <li><a href="index.html" class="navlink">Αρχική</a></li>
          <li><a href="ways.html" class="navlink"> Δράσεις</a></li>
          <li><a href="add.html" class="navlink active">Υποβολή Δράσης</a></li>
          <li><a href="rewards.html" class="navlink">Δώρα Διαγωνισμού</a></li>
          <li><a href="games.html" class="navlink">Παιχνίδια</a></li>
          <li><a href="leaderboard.html" class="navlink">Κατάταξη</a></li>
          <li><a href="account.html" class="navlink">Ο Λογαριασμός μου</a></li>
          <li id="authArea"></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="page">
      <h2>Υπόβαλε τη δική σου δράση</h2>
      <p class="muted">Απαιτείται σύνδεση για να εμφανίζονται τα στοιχεία σου στον πίνακα — προς το παρόν αποθηκεύουμε ό,τι υποβάλλεις δημόσια.</p>

      <form id="actionForm" class="card p" style="padding:16px">
        <div class="row">
          <div><label for="title">Τίτλος δράσης</label><input id="title" required placeholder="Π.χ. Δενδροφύτευση στη γειτονιά"/></div>
          <div><label for="category">Κατηγορία</label>
            <select id="category">
              <option>Ενέργεια</option><option>Μετακίνηση</option><option>Ανακύκλωση</option>
              <option>Νερό</option><option>Σχολείο</option><option>Κοινότητα</option>
            </select>
          </div>
        </div>

        <label>Εικόνα Δράσης</label>
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
          <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/jpg"/>
          <input id="image" placeholder="Ή επικόλλησε URL εικόνας (https://...)" style="flex:1"/>
        </div>
        <img id="preview" alt="Προεπισκόπηση" style="margin-top:10px;max-width:240px;display:none;border-radius:10px;border:1px solid #134"/>

        <label for="link">Σύνδεσμος/περισσότερα</label><input id="link" placeholder="https://..."/>
        <label for="desc">Περιγραφή</label><textarea id="desc" rows="4" placeholder="Τι κάνατε, πού, πότε, υλικά, ομάδα, επίδραση..."></textarea>

        <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <button class="btn" type="submit">Αποθήκευση δράσης</button><span class="muted" id="formMsg"></span>
        </div>
      </form>

      <h3 style="margin-top:24px">Δημόσιες δράσεις</h3>
      <div class="grid cards" id="actionsList"></div>
    </section>
  </main>

  <footer class="container">Η Γη δεν χρειάζεται σωτήρες, χρειάζεται συμμάχους. • © Olympion 2025</footer>

  <!-- dialogs (κρατάμε τα ίδια) -->
  <dialog id="authDialog"> ... </dialog>
  <dialog id="tipDialog"> ... </dialog>

  <!-- Firebase helper -->
  <!-- Firebase: Λειτουργία υποβολής δράσης + πόντοι -->
<script type="module">
  import { db } from './assets/js/fb.js';
  import { collection, addDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { addPoints } from './assets/js/auth.js';

  const form = document.querySelector('#actionForm');
  const msgEl = document.querySelector('#formMsg');
  const prevEl = document.querySelector('#preview');

  // ---- Preview εικόνας ----
  let uploadedDataURL = '';
  document.querySelector('#imageUpload')?.addEventListener('change', e=>{
    const f = e.target.files?.[0];
    if(f && f.type.startsWith('image/')){
      const r = new FileReader();
      r.onload = ev => {
        uploadedDataURL = ev.target.result;
        if(prevEl){
          prevEl.src = uploadedDataURL;
          prevEl.style.display = 'block';
        }
      };
      r.readAsDataURL(f);
    }
  });

  // ---- Όνομα χρήστη (προβολή) ----
  function currentDisplayName(){
    const data = JSON.parse(localStorage.getItem("eco_user"));
    return data?.display || "guest";
  }

  // ---- Υποβολή δράσης ----
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const title = document.querySelector('#title').value.trim();
    const category = document.querySelector('#category').value;
    const link = document.querySelector('#link').value.trim();
    const desc = document.querySelector('#desc').value.trim();
    const image = uploadedDataURL || document.querySelector('#image')?.value.trim() || '';

    if(!title || !category || !desc){
      msgEl.textContent = '⚠️ Συμπλήρωσε τίτλο, κατηγορία και περιγραφή.';
      return;
    }

    try{
      // Αποθήκευση δράσης
      await addDoc(collection(db, 'actions'), {
        title, category, link, desc, image,
        ownerName: currentDisplayName(),
        created: serverTimestamp()
      });

      // ➕ Προσθήκη πόντων στο συνδεδεμένο χρήστη
      const userData = JSON.parse(localStorage.getItem("eco_user"));
      if (userData) {
        await addPoints(userData.uid, 5); // +5 πόντοι
        console.log("✅ Προστέθηκαν +5 πόντοι στον χρήστη:", userData.display);
      } else {
        console.log("Δεν είσαι συνδεδεμένος — δεν απονεμήθηκαν πόντοι.");
      }

      msgEl.textContent = '✅ Η δράση αποθηκεύτηκε με επιτυχία!';
      form.reset();
      if(prevEl) prevEl.style.display = 'none';
      uploadedDataURL = '';
    } catch(err){
      msgEl.textContent = '❌ Σφάλμα: ' + (err?.message || err);
    }
  });
</script>


  <!-- keep app.js for other UI bits (nav, auth dialog rendering etc.) -->
  <script type="module" src="assets/js/fb.js"></script>
  <script type="module" src="assets/js/auth.js"></script>
  <script src="assets/js/app.js"></script>
  
</body>
</html>
